<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>검색 결과</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h2>🎬 검색 결과</h2>
  <ul id="search-result"></ul>

  <script>
    const tmdbKey = '234ef78df71e08e515ca2d691678e0f1';
    const kobisKey = '455015aa3f97520437568b039887193b';

    // URL에서 query 파라미터 가져오기
    const params = new URLSearchParams(window.location.search);
    const query = params.get('query');

    if (query) {
      // KOBIS 영화 검색
      $.ajax({
        url: 'https://www.kobis.or.kr/kobisopenapi/webservice/rest/movie/searchMovieList.json',
        type: 'GET',
        data: {
          key: kobisKey,
          movieNm: query
        },
        success: function (data) {
          const list = data.movieListResult.movieList.slice(0, 10);
          if (list.length === 0) {
            $('#search-result').append('<li>검색 결과가 없습니다.</li>');
          } else {
            list.forEach(movie => {
              fetchPoster(movie.movieNm, movie.prdtYear, function (posterUrl) {
                const posterImg = posterUrl ? `<img src="${posterUrl}" width="80" />` : '';
                $('#search-result').append(`<li>${posterImg} <strong>${movie.movieNm}</strong> (${movie.prdtYear})</li>`);
              });
            });
          }
        },
        error: err => console.error('KOBIS 에러:', err)
      });
    }

    // TMDB 포스터 가져오기
    function fetchPoster(title, year, callback) {
      $.ajax({
        url: 'https://api.themoviedb.org/3/search/movie',
        type: 'GET',
        data: {
          api_key: tmdbKey,
          query: title,
          year: year,
          language: 'ko'
        },
        success: function (res) {
          const posterPath = res.results[0]?.poster_path;
          callback(posterPath ? `https://image.tmdb.org/t/p/w200${posterPath}` : null);
        },
        error: err => {
          console.error('TMDB 에러:', err);
          callback(null);
        }
      });
    }
  </script>
</body>
</html>
